{% load staticfiles %}
<script> 

    function init() {
     
    canvas = new fabric.Canvas('parallax');

    fabric.Image.fromURL("{% static user_img %}", function(img) {
        img.set({
            width: canvas.width, 
            height: canvas.height, 
            originX: 'left', 
            originY: 'top',
        });
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
    });

    var cont = 50

    $("#btn1").click(function(event){
        event.preventDefault();
        console.log("Criou um novo objeto!!")
        fabric.Image.fromURL("{% static 'img/goose.png' %}", function(img) {
            img.set({
                left: cont, 
                top: cont,
                width: 50,
                height: 50,
            });
            canvas.add(img)
            cont = cont + 20
        });
    })
   

    $("#btn2").click(function(event){
        event.preventDefault();
        console.log("Apagou objeto!!");
        canvas.getActiveObject().remove();
    })

//    fabric.Image.fromURL("{% static 'img/goose.png' %}", function(img) {
//        img.set({
//            left: 50, 
//            top: 50,
//            width: 50,
//            height: 50,
//        });
//        canvas.add(img)
//    });

    // Touch

    var info = document.getElementById('info');
                           
    canvas.on({            
        'touch:gesture': function() {
            var text = document.createTextNode(' Gesture ');
            info.insertBefore(text, info.firstChild);
        },
        'touch:drag': function() {
            var text = document.createTextNode(' Dragging ');
            info.insertBefore(text, info.firstChild);
        },
        'touch:orientation': function() {
            var text = document.createTextNode(' Orientation ');
            info.insertBefore(text, info.firstChild);
        },                 
        'touch:shake': function() {
            var text = document.createTextNode(' Shaking ');
            info.insertBefore(text, info.firstChild);
        },
        'touch:longpress': function() {
            var text = document.createTextNode(' Longpress ');
             info.insertBefore(text, info.firstChild);
        }
    }); 


    // Colisão
    canvas.observe('object:scaling', function (e) {
        var obj = e.target;
        if(obj.getHeight() > obj.canvas.height || obj.getWidth() > obj.canvas.width){
            obj.setScaleY(obj.originalState.scaleY);
            obj.setScaleX(obj.originalState.scaleX);        
        }
        obj.setCoords();
        if(obj.getBoundingRect().top - (obj.cornerSize / 2) < 0 || obj.getBoundingRect().left -  (obj.cornerSize / 2) < 0) {
            obj.top = Math.max(obj.top, obj.top-obj.getBoundingRect().top + (obj.cornerSize / 2));
            obj.left = Math.max(obj.left, obj.left-obj.getBoundingRect().left + (obj.cornerSize / 2));    
        }
        if(obj.getBoundingRect().top+obj.getBoundingRect().height + obj.cornerSize  > obj.canvas.height || obj.getBoundingRect().left+obj.getBoundingRect().width + obj.cornerSize  > obj.canvas.width) {
            obj.top = Math.min(obj.top, obj.canvas.height-obj.getBoundingRect().height+obj.top-obj.getBoundingRect().top - obj.cornerSize / 2);
            obj.left = Math.min(obj.left, obj.canvas.width-obj.getBoundingRect().width+obj.left-obj.getBoundingRect().left - obj.cornerSize /2);    
        }
    });

    canvas.observe('object:moving', function (e) {
        var obj = e.target;
        if(obj.getHeight() > obj.canvas.height || obj.getWidth() > obj.canvas.width){
            obj.setScaleY(obj.originalState.scaleY);
            obj.setScaleX(obj.originalState.scaleX);        
        }
        obj.setCoords();
        if(obj.getBoundingRect().top - (obj.cornerSize / 2) < 0 || obj.getBoundingRect().left -  (obj.cornerSize / 2) < 0) {
            obj.top = Math.max(obj.top, obj.top-obj.getBoundingRect().top + (obj.cornerSize / 2));
            obj.left = Math.max(obj.left, obj.left-obj.getBoundingRect().left + (obj.cornerSize / 2));    
        } 
        if(obj.getBoundingRect().top+obj.getBoundingRect().height + obj.cornerSize  > obj.canvas.height || obj.getBoundingRect().left+obj.getBoundingRect().width + obj.cornerSize  > obj.canvas.width) {
        obj.left = Math.min(obj.left, obj.canvas.width-obj.getBoundingRect().width+obj.left-obj.getBoundingRect().left - obj.cornerSize /2);    
        }
    });


//*
var element = $("#html-content-holder"); // global variable
var getCanvas = canvas; // global variable

$("#btn-Convert-Html2Image").on('click', function () { 
    console.log("Download da tela!!");
    var imgageData = getCanvas.toDataURL("image/png");
    // Now browser starts downloading it instead of just showing it
    var newData = imgageData.replace(/^data:image\/png/, "data:application/octet-stream");
    $("#btn-Convert-Html2Image").attr("download", "simulador.png").attr("href", newData);
});
//*


//        renderer = PIXI.autoDetectRenderer(
//            640,
//            480,
//            {view:document.getElementById("parallax")}
//        );
//
//        // raiz
//        var stage = new PIXI.Container();
//
//
//        var container = new PIXI.Container();
//        // container dentro de raiz
//        stage.addChild(container);
//
//        // Tamanho máximo da imagem: 2048x1536
//        var userTexture = PIXI.Texture.fromImage("{% static user_img %}");
//        var user = new PIXI.Sprite(userTexture);
//
//        // scale 0.4 para 2048x1536
//        // scale 0.8 para 800x600
//        user.scale.set(0.4);
//
//        container.addChild(user);
//
//
//        //GOOSE
//
//        // container
//        var container = new PIXI.Container();
//        // container dentro de raiz
//        stage.addChild(container);
//
//        var farTexture = PIXI.Texture.fromImage("{% static 'img/goose.png' %}");
//        var far = new PIXI.Sprite(farTexture);
//
//        container.x = 10;
//        container.y = 10;
//
//        far.interactive = true;
//
//        far.buttonMode = true;
//
//        far
//            // events for drag start
//            .on('mousedown', onDragStart)
//            .on('touchstart', onDragStart)
//            // events for drag end
//            .on('mouseup', onDragEnd)
//            .on('mouseupoutside', onDragEnd)
//            .on('touchend', onDragEnd)
//            .on('touchendoutside', onDragEnd)
//            // events for drag move
//            .on('mousemove', onDragMove)
//            .on('touchmove', onDragMove);
//
//        //add it to the stage
//        container.addChild(far);
//
//
//        // start animating
//        animate();
//        
//        function animate() {
//             
//            requestAnimationFrame(animate);
//        
//            // render the root container
//            renderer.render(stage);
//        }
//
//        function onDragStart(event){
//            // store a reference to the data
//            // the reason for this is because of multitouch
//            // we want to track the movement of this particular touch
//            this.data = event.data;
//            this.alpha = 0.5;
//            this.dragging = true;
//        }
//    
//        function onDragEnd()
//        {
//            this.alpha = 1;
//        
//            this.dragging = false;
//        
//            // set the interaction data to null
//            this.data = null;
//        }
//        
//        function onDragMove()
//        {
//            if (this.dragging)
//            {
//                var newPosition = this.data.getLocalPosition(this.parent);
//                this.position.x = newPosition.x;
//                this.position.y = newPosition.y;
//            }
//        }

}
</script>
